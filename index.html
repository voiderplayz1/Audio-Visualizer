<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studio Visualizer - Golden Final</title>
    <style>
        :root { --accent: #F4EBE2; --bg: #050505; }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: #fff; font-family: 'Segoe UI', system-ui, sans-serif; 
            height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0; 
        }

        /* Sidebar UI */
        #sidebar {
            position: absolute; top: 20px; left: 20px; width: 320px; 
            background: rgba(15, 15, 15, 0.9); backdrop-filter: blur(20px);
            padding: 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
            z-index: 100; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .group { margin-bottom: 18px; }
        .label-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        label { font-size: 10px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        .val-display { font-size: 11px; color: var(--accent); font-family: monospace; }
        
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; height: 4px; }
        select, input[type="color"] { background: #111; border: 1px solid #333; color: white; padding: 8px; border-radius: 5px; width: 100%; }

        .btn { background: #222; color: white; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; margin-top: 5px; }
        .btn:hover { border-color: var(--accent); }
        .btn-accent { background: var(--accent); color: #000; border: none; }

        #fx-panel { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; border-top: 0px solid #333; margin-top: 10px; }
        #fx-panel.open { max-height: 800px; border-top-width: 1px; padding-top: 15px; }

        /* Stages */
        #main-stage { flex: 1; position: relative; }
        #bottom-panel { height: 140px; background: #000; border-top: 1px solid #222; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        
        #play-pause { 
            position: absolute; left: 25px; top: 45px; width: 50px; height: 50px; 
            border-radius: 50%; border: none; background: var(--accent); 
            cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <label class="btn btn-accent">1. Upload Track<input type="file" id="upload" accept="audio/*" hidden></label>

    <div class="group" style="margin-top:20px;">
        <label>Visual Mode</label>
        <select id="mode">
            <option value="lissajous">Dynamic Lissajous</option>
            <option value="circular">Circular Burst</option>
            <option value="bars">Frequency Bars</option>
            <option value="wave">Chaotic Waveform</option>
        </select>
    </div>

    <div class="group">
        <label>Glow Color</label>
        <input type="color" id="color-picker" value="#F4EBE2">
    </div>

    <div class="group">
        <div class="label-row"><label>Line Thickness</label><span class="val-display" id="v-weight">3.00</span></div>
        <input type="range" id="weight" min="1" max="15" step="0.1" value="3">
    </div>

    <div class="group">
        <div class="label-row"><label>Line Distance</label><span class="val-display" id="v-dist">2.00</span></div>
        <input type="range" id="dist" min="0" max="20" step="1" value="2">
    </div>

    <div class="group">
        <div class="label-row"><label>Glow Distance</label><span class="val-display" id="v-glow">1.00</span></div>
        <input type="range" id="glow" min="0.1" max="5.0" step="0.1" value="1.0">
    </div>

    <button class="btn" id="toggle-eq">Master FX / EQ ▾</button>

    <div id="fx-panel">
        <div class="group"><div class="label-row"><label>Volume</label><span class="val-display" id="v-vol">1.00</span></div><input type="range" id="vol" min="0" max="2" step="0.01" value="1"></div>
        <div class="group"><div class="label-row"><label>Bass Boost</label><span class="val-display" id="v-bass">1.00</span></div><input type="range" id="bass" min="0.1" max="5" step="0.1" value="1"></div>
        <div class="group"><div class="label-row"><label>Bit Crush</label><span class="val-display" id="v-crush">0.00</span></div><input type="range" id="crush" min="0" max="50" step="1" value="0"></div>
        <div class="group"><div class="label-row"><label>Pitch</label><span class="val-display" id="v-pitch">1.00</span></div><input type="range" id="pitch" min="0.5" max="2" step="0.01" value="1"></div>
        <div class="group"><div class="label-row"><label>Time Speed</label><span class="val-display" id="v-speed">1.00</span></div><input type="range" id="speed" min="0.5" max="2" step="0.01" value="1"></div>
        <div class="group"><div class="label-row"><label>Reverb</label><span class="val-display" id="v-reverb">0.00</span></div><input type="range" id="reverb" min="0" max="1" step="0.01" value="0"></div>
        <button class="btn btn-accent" id="wacky">WACKY!!1!</button>
    </div>

    <button class="btn" id="reset" style="color:#ff4444; border-color:#441111; margin-top:10px;">Clear Session</button>
</div>

<div id="main-stage"><canvas id="canvas"></canvas></div>
<div id="bottom-panel">
    <button id="play-pause">▶</button>
    <canvas id="trace"></canvas>
</div>

<script>
    let audioCtx, source, analyser, gainNode, bassNode, crushNode, reverbNode, reverbGain;
    let audioBuffer = null, isPlaying = false, startTime = 0, offset = 0;
    let lissA = 3, lissB = 2;

    const canvas = document.getElementById('canvas'), ctx = canvas.getContext('2d');
    const trace = document.getElementById('trace'), tCtx = trace.getContext('2d');

    // UI Logic
    document.getElementById('toggle-eq').onclick = () => document.getElementById('fx-panel').classList.toggle('open');
    
    // Auto-update value displays
    document.querySelectorAll('input[type=range]').forEach(i => {
        i.addEventListener('input', () => {
            const display = document.getElementById('v-' + i.id);
            if(display) display.innerText = parseFloat(i.value).toFixed(2);
        });
    });

    async function initAudio(file) {
        if (!audioCtx) audioCtx = new AudioContext();
        const data = await file.arrayBuffer();
        audioBuffer = await audioCtx.decodeAudioData(data);
        startPlayback();
    }

    function startPlayback() {
        if (source) source.stop();
        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;

        analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
        gainNode = audioCtx.createGain();
        bassNode = audioCtx.createBiquadFilter(); bassNode.type = 'lowshelf'; bassNode.frequency.value = 200;
        crushNode = audioCtx.createWaveShaper();
        
        reverbNode = audioCtx.createConvolver();
        const len = audioCtx.sampleRate * 2;
        const imp = audioCtx.createBuffer(2, len, audioCtx.sampleRate);
        for(let i=0; i<len; i++) { imp.getChannelData(0)[i] = (Math.random()*2-1)*Math.pow(1-i/len, 2); }
        reverbNode.buffer = imp;
        reverbGain = audioCtx.createGain(); reverbGain.gain.value = 0;

        // Routing
        source.connect(bassNode).connect(crushNode).connect(analyser);
        analyser.connect(gainNode);
        analyser.connect(reverbNode).connect(reverbGain).connect(gainNode);
        gainNode.connect(audioCtx.destination);

        source.start(0);
        isPlaying = true;
        animate();
    }

    document.getElementById('upload').onchange = (e) => initAudio(e.target.files[0]);
    document.getElementById('play-pause').onclick = () => {
        if(!audioCtx) return;
        isPlaying ? audioCtx.suspend() : audioCtx.resume();
        isPlaying = !isPlaying;
        document.getElementById('play-pause').innerText = isPlaying ? "⏸" : "▶";
    };

    document.getElementById('wacky').onclick = () => {
        const r = (id, min, max) => {
            const val = Math.random() * (max - min) + min;
            const el = document.getElementById(id);
            el.value = val;
            el.dispatchEvent(new Event('input'));
        };
        r('pitch', 0.5, 2); r('speed', 0.5, 2); r('reverb', 0, 1);
        r('bass', 0.1, 5); r('crush', 0, 50); r('weight', 1, 10);
        document.getElementById('color-picker').value = '#' + Math.floor(Math.random()*16777215).toString(16);
        lissA = Math.random() * 5; lissB = Math.random() * 5;
    };

    function animate() {
        requestAnimationFrame(animate);
        canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
        trace.width = trace.clientWidth; trace.height = 140;

        const fData = new Uint8Array(analyser.frequencyBinCount);
        const tData = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(fData);
        analyser.getByteTimeDomainData(tData);

        // Update FX
        if(source) {
            source.playbackRate.value = document.getElementById('pitch').value * document.getElementById('speed').value;
            gainNode.gain.value = document.getElementById('vol').value;
            bassNode.gain.value = (document.getElementById('bass').value - 1) * 20;
            reverbGain.gain.value = document.getElementById('reverb').value;
            
            // Bit Crush logic
            const amt = document.getElementById('crush').value;
            if(amt > 0) {
                const curve = new Float32Array(44100);
                for(let i=0; i<44100; i++) {
                    let x = i * 2 / 44100 - 1;
                    curve[i] = Math.round(x * amt) / amt;
                }
                crushNode.curve = curve;
            } else { crushNode.curve = null; }
        }

        const color = document.getElementById('color-picker').value;
        ctx.strokeStyle = color;
        ctx.lineWidth = document.getElementById('weight').value;
        ctx.shadowBlur = 15 * document.getElementById('glow').value;
        ctx.shadowColor = color;
        
        const mode = document.getElementById('mode').value;
        const cx = canvas.width/2, cy = canvas.height/2;

        if (mode === 'lissajous') {
            ctx.beginPath();
            let volumeSum = fData.reduce((a,b)=>a+b, 0) / fData.length;
            let scale = (volumeSum / 128) + 0.5; // Dynamic expansion
            for (let i = 0; i < tData.length; i++) {
                const angle = (i / tData.length) * Math.PI * 2;
                const v = tData[i] / 128.0;
                const x = cx + Math.sin(angle * lissA) * (canvas.width / 4) * v * scale;
                const y = cy + Math.cos(angle * lissB) * (canvas.height / 4) * v * scale;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
        } else if (mode === 'circular') {
            const dist = parseInt(document.getElementById('dist').value);
            for (let i = 0; i < fData.length; i += (1 + dist)) {
                const angle = (i / fData.length) * Math.PI * 2;
                const len = fData[i] * 0.8;
                ctx.beginPath();
                ctx.moveTo(cx + Math.cos(angle)*80, cy + Math.sin(angle)*80);
                ctx.lineTo(cx + Math.cos(angle)*(80+len), cy + Math.sin(angle)*(80+len));
                ctx.stroke();
            }
        } else if (mode === 'bars') {
            const dist = parseInt(document.getElementById('dist').value);
            let x = 0; let barW = (canvas.width / fData.length) * (dist + 1);
            for(let i=0; i<fData.length; i += (1+dist)) {
                let h = fData[i] * (canvas.height/255);
                ctx.strokeRect(x, canvas.height - h, barW, h);
                x += barW + dist;
            }
        } else if (mode === 'wave') {
            ctx.beginPath(); let x = 0; let step = canvas.width / tData.length;
            for(let i=0; i<tData.length; i++) {
                let y = (tData[i]/128.0) * cy;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                x += step;
            }
            ctx.stroke();
        }

        // DRAW BOTTOM TRACE (Peaks)
        const progress = (audioCtx.currentTime % audioBuffer.duration) / audioBuffer.duration;
        const tx = progress * trace.width;
        tCtx.strokeStyle = color; tCtx.lineWidth = 1;
        tCtx.beginPath();
        tCtx.moveTo(tx, 70 - fData[5]/3);
        tCtx.lineTo(tx, 70 + fData[5]/3);
        tCtx.stroke();
    }
</script>
</body>
</html>
