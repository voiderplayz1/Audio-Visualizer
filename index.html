<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Studio Visualizer</title>
    <style>
        :root { --accent: #ff9d00; --bg: #050505; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background-color: var(--bg); 
            color: #fff; 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* Floating Studio Controls */
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(15, 15, 15, 0.85);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
            width: 280px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
        }

        h2 { font-size: 1rem; text-align: center; text-transform: uppercase; letter-spacing: 3px; color: var(--accent); margin-bottom: 5px; }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 0.75rem; color: #888; text-transform: uppercase; font-weight: bold; }

        .btn, select, input[type="color"] {
            background-color: #1a1a1a;
            color: white;
            border: 1px solid #333;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn:hover { background-color: #252525; border-color: #555; }
        
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }
        input[type="file"] { display: none; }
        
        .upload-label { background-color: var(--accent); color: #000; border: none; text-align: center; }
        .upload-label:hover { filter: brightness(1.2); }

        /* Expanding EQ Panel */
        #eq-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        #eq-panel.open { max-height: 500px; padding: 15px 0; border-top: 1px solid #333; margin-top: 10px; }

        /* Layout */
        #main-stage { flex: 3; position: relative; width: 100%; }
        #bottom-panel { 
            flex: 1; 
            background-color: #080808; 
            border-top: 1px solid #222; 
            display: flex; 
            flex-direction: column;
            padding: 15px 20px;
            gap: 10px;
        }

        #playback-row { display: flex; align-items: center; gap: 15px; }
        #play-pause { 
            background: var(--accent); border: none; width: 45px; height: 45px; 
            border-radius: 50%; cursor: pointer; font-size: 1.2rem; flex-shrink: 0;
        }
        #scrubber { flex-grow: 1; height: 6px; }

        canvas { display: block; width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="controls">
        <h2>Studio FX</h2>
        
        <label for="audio-upload" class="btn upload-label">Upload Audio</label>
        <input type="file" id="audio-upload" accept=".mp3, .ogg, .wav, .flac" />
        
        <div class="control-group">
            <label>Visual Mode</label>
            <select id="mode-selector">
                <option value="lissajous">Lissajous (XY Logo)</option>
                <option value="0">Chaotic Waveform</option>
                <option value="1">Frequency Bars</option>
                <option value="2">Circular Burst</option>
                <option value="3">Symmetrical Wave</option>
            </select>
        </div>

        <div class="control-group">
            <label>Glow Color</label>
            <input type="color" id="color-picker" value="#ff9d00">
        </div>

        <div class="control-group">
            <label>Line Thickness</label>
            <input type="range" id="line-weight" min="1" max="15" value="3">
        </div>

        <button id="btn-toggle-eq" class="btn">Open Audio FX ▾</button>

        <div id="eq-panel">
            <div class="control-group">
                <label id="label-bass">Bass Boost (1.0)</label>
                <input type="range" id="fx-bass" min="0.1" max="5.0" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label id="label-crush">Bit Crush (1.0)</label>
                <input type="range" id="fx-crush" min="0.1" max="5.0" step="0.1" value="1.0">
            </div>
            <div class="control-group">
                <label id="label-pitch">Pitch / Speed (1.0)</label>
                <input type="range" id="fx-pitch" min="0.1" max="5.0" step="0.1" value="1.0">
            </div>
            <div class="control-group" style="flex-direction: row; justify-content: space-between; align-items: center;">
                <label>Auto-Tune</label>
                <input type="checkbox" id="fx-autotune" style="width: 20px; height: 20px;">
            </div>
            <button id="btn-wacky" class="btn" style="background: #442200; border-color: #ff9d00;">Wacky!!1!</button>
        </div>

        <button id="btn-remove" class="btn" style="color: #ff4444; border-color: #441111;">Track Remover</button>
    </div>

    <div id="main-stage">
        <canvas id="main-canvas"></canvas>
    </div>

    <div id="bottom-panel">
        <div id="playback-row">
            <button id="play-pause">▶</button>
            <input type="range" id="scrubber" value="0" min="0" step="0.01">
        </div>
        <canvas id="timeline-canvas"></canvas>
    </div>

    <audio id="audio-player"></audio>

    <script>
        const audioPlayer = document.getElementById('audio-player');
        const mainCanvas = document.getElementById('main-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        const timelineCanvas = document.getElementById('timeline-canvas');
        const timelineCtx = timelineCanvas.getContext('2d');
        
        // UI Controls
        const scrubber = document.getElementById('scrubber');
        const playBtn = document.getElementById('play-pause');
        const eqPanel = document.getElementById('eq-panel');
        const btnToggleEq = document.getElementById('btn-toggle-eq');

        let audioCtx, analyser, source, bassNode, crushNode;
        let animationId;
        let visualizerMode = 'lissajous';
        let glowColor = '#ff9d00';
        let lineWeight = 3;

        function resize() {
            mainCanvas.width = mainCanvas.clientWidth;
            mainCanvas.height = mainCanvas.clientHeight;
            timelineCanvas.width = timelineCanvas.clientWidth;
            timelineCanvas.height = timelineCanvas.clientHeight;
        }
        window.onresize = resize;
        resize();

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;
            
            source = audioCtx.createMediaElementSource(audioPlayer);

            // FX Nodes
            bassNode = audioCtx.createBiquadFilter();
            bassNode.type = "lowshelf";
            bassNode.frequency.value = 200;

            crushNode = audioCtx.createWaveShaper();

            source.connect(bassNode);
            bassNode.connect(crushNode);
            crushNode.connect(analyser);
            analyser.connect(audioCtx.destination);
        }

        function makeDistortionCurve(amount) {
            let k = amount * 10, n = 44100, curve = new Float32Array(n);
            for (let i=0; i<n; i++) {
                let x = i * 2 / n - 1;
                curve[i] = (3 + k) * x * 20 * (Math.PI / 180) / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        // Toggle EQ Panel
        btnToggleEq.onclick = () => eqPanel.classList.toggle('open');

        // FX Sliders
        document.getElementById('fx-bass').oninput = (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('label-bass').innerText = `Bass Boost (${val.toFixed(1)})`;
            if(bassNode) bassNode.gain.value = (val - 1) * 25;
        };

        document.getElementById('fx-crush').oninput = (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('label-crush').innerText = `Bit Crush (${val.toFixed(1)})`;
            if(crushNode) crushNode.curve = makeDistortionCurve(val - 1);
        };

        document.getElementById('fx-pitch').oninput = (e) => {
            const val = parseFloat(e.target.value);
            document.getElementById('label-pitch').innerText = `Pitch / Speed (${val.toFixed(1)})`;
            audioPlayer.playbackRate = val;
        };

        document.getElementById('btn-wacky').onclick = () => {
            const r = (min, max) => Math.random() * (max - min) + min;
            document.getElementById('fx-pitch').value = r(0.5, 3);
            document.getElementById('fx-bass').value = r(0.1, 5);
            document.getElementById('fx-crush').value = r(0.1, 5);
            glowColor = '#' + Math.floor(Math.random()*16777215).toString(16);
            document.getElementById('color-picker').value = glowColor;
            // Trigger updates
            document.getElementById('fx-pitch').dispatchEvent(new Event('input'));
            document.getElementById('fx-bass').dispatchEvent(new Event('input'));
            document.getElementById('fx-crush').dispatchEvent(new Event('input'));
        };

        // File handling
        document.getElementById('audio-upload').onchange = function(e) {
            initAudio();
            audioPlayer.src = URL.createObjectURL(e.target.files[0]);
            audioPlayer.play();
            playBtn.innerText = "⏸";
            timelineCtx.clearRect(0, 0, timelineCanvas.width, timelineCanvas.height);
            draw();
        };

        playBtn.onclick = () => {
            audioPlayer.paused ? audioPlayer.play() : audioPlayer.pause();
            playBtn.innerText = audioPlayer.paused ? "▶" : "⏸";
        };

        document.getElementById('btn-remove').onclick = () => {
            audioPlayer.pause(); audioPlayer.src = "";
            mainCtx.clearRect(0,0,mainCanvas.width, mainCanvas.height);
            timelineCtx.clearRect(0,0,timelineCanvas.width, timelineCanvas.height);
        };

        document.getElementById('mode-selector').onchange = (e) => visualizerMode = e.target.value;
        document.getElementById('color-picker').oninput = (e) => glowColor = e.target.value;
        document.getElementById('line-weight').oninput = (e) => lineWeight = e.target.value;

        // Scrubber Sync
        audioPlayer.ontimeupdate = () => {
            if(!isNaN(audioPlayer.duration)){
                scrubber.max = audioPlayer.duration;
                scrubber.value = audioPlayer.currentTime;
            }
        };
        scrubber.oninput = () => audioPlayer.currentTime = scrubber.value;

        function draw() {
            animationId = requestAnimationFrame(draw);
            const bufferLength = analyser.frequencyBinCount;
            const dataFreq = new Uint8Array(bufferLength);
            const dataTime = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataFreq);
            analyser.getByteTimeDomainData(dataTime);

            // 1. Main Stage Draw
            mainCtx.fillStyle = 'rgba(5, 5, 5, 0.2)';
            mainCtx.fillRect(0, 0, mainCanvas.width, mainCanvas.height);
            
            mainCtx.shadowBlur = 15;
            mainCtx.shadowColor = glowColor;
            mainCtx.strokeStyle = glowColor;
            mainCtx.lineWidth = lineWeight;

            const w = mainCanvas.width, h = mainCanvas.height;
            mainCtx.beginPath();

            if (visualizerMode === 'lissajous') {
                for(let i = 0; i < bufferLength; i++) {
                    const x = (dataTime[i] / 128.0) * (w / 3) + (w / 3);
                    const y = (dataTime[(i + 10) % bufferLength] / 128.0) * (h / 3) + (h / 3);
                    if(i === 0) mainCtx.moveTo(x, y); else mainCtx.lineTo(x, y);
                }
            } else if (visualizerMode === '0') {
                let x = 0, slice = w / bufferLength;
                for(let i = 0; i < bufferLength; i++) {
                    const v = dataTime[i] / 128.0;
                    const y = v * h / 2;
                    if(i === 0) mainCtx.moveTo(x, y); else mainCtx.lineTo(x, y);
                    x += slice;
                }
            } else if (visualizerMode === '1') {
                const barWidth = (w / bufferLength) * 2.5;
                let x = 0;
                for(let i = 0; i < bufferLength; i++) {
                    const barHeight = dataFreq[i] * (h / 255) * 0.8;
                    mainCtx.fillStyle = glowColor;
                    mainCtx.fillRect(x, h - barHeight, barWidth, barHeight);
                    x += barWidth + 2;
                }
            } else if (visualizerMode === '2') {
                const radius = Math.min(w, h) * 0.2;
                for(let i = 0; i < bufferLength; i += 4) {
                    const barHeight = dataFreq[i] * 0.6;
                    const rads = Math.PI * 2 * (i / bufferLength);
                    mainCtx.moveTo(w/2 + Math.cos(rads)*radius, h/2 + Math.sin(rads)*radius);
                    mainCtx.lineTo(w/2 + Math.cos(rads)*(radius+barHeight), h/2 + Math.sin(rads)*(radius+barHeight));
                }
            } else if (visualizerMode === '3') {
                let x = 0, slice = w / bufferLength;
                for(let i = 0; i < bufferLength; i++) {
                    const v = (dataTime[i] - 128) / 128.0;
                    const offset = v * (h * 0.4);
                    mainCtx.moveTo(x, h/2); mainCtx.lineTo(x, h/2 + offset);
                    mainCtx.moveTo(x, h/2); mainCtx.lineTo(x, h/2 - offset);
                    x += slice;
                }
            }
            mainCtx.stroke();
            mainCtx.shadowBlur = 0;

            // 2. Timeline Draw (Building as it goes)
            if (!audioPlayer.paused && audioPlayer.duration) {
                const progress = audioPlayer.currentTime / audioPlayer.duration;
                const currentX = progress * timelineCanvas.width;
                let sum = 0;
                for(let i = 0; i < 100; i++) sum += dataFreq[i];
                const peakHeight = (sum / 100 / 255) * timelineCanvas.height;
                
                timelineCtx.strokeStyle = glowColor;
                timelineCtx.lineWidth = 1;
                timelineCtx.beginPath();
                timelineCtx.moveTo(currentX, (timelineCanvas.height/2) - (peakHeight/2));
                timelineCtx.lineTo(currentX, (timelineCanvas.height/2) + (peakHeight/2));
                timelineCtx.stroke();
            }
        }
    </script>
</body>
</html>
