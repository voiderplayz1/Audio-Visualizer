<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Studio Visualizer - Golden Version</title>
    <style>
        :root { --accent: #F4EBE2; --bg: #050505; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; margin: 0; }
        #sidebar {
            position: absolute; top: 20px; left: 20px; width: 300px; 
            background: rgba(15, 15, 15, 0.95); padding: 20px; border-radius: 12px;
            border: 1px solid #333; z-index: 100; max-height: 90vh; overflow-y: auto;
        }
        .group { margin-bottom: 15px; }
        label { display: block; font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); }
        .btn { background: var(--accent); color: #000; border: none; padding: 10px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }
        #main-stage { flex: 1; position: relative; cursor: crosshair; }
        #bottom-panel { height: 120px; background: #000; border-top: 1px solid #222; position: relative; }
        canvas { display: block; width: 100%; height: 100%; }
        #play-btn { position: absolute; left: 20px; top: 40px; width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--accent); cursor: pointer; }
    </style>
</head>
<body>

<div id="sidebar">
    <label>Audio Source</label>
    <input type="file" id="upload" accept="audio/*">
    <div class="group">
        <label>Visual Mode</label>
        <select id="mode" style="width:100%; padding:5px; background:#111; color:white;">
            <option value="lissajous">Dynamic Lissajous (Golden)</option>
            <option value="circular">Circular Burst (Uncompressed)</option>
            <option value="bars">Frequency Bars</option>
        </select>
    </div>
    <div class="group">
        <label id="lbl-weight">Line Thickness: 3</label>
        <input type="range" id="weight" min="1" max="10" value="3">
    </div>
    <div class="group">
        <label id="lbl-dist">Line Distance: 2</label>
        <input type="range" id="dist" min="0" max="20" value="2">
    </div>
    <div class="group">
        <label id="lbl-glow">Glow Distance: 1.0</label>
        <input type="range" id="glow" min="0.1" max="5.0" step="0.1" value="1.0">
    </div>
    <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
    <div class="group">
        <label>Master Volume</label>
        <input type="range" id="vol" min="0" max="2" step="0.1" value="1">
    </div>
    <div class="group">
        <label>Pitch Shifter</label>
        <input type="range" id="pitch" min="0.5" max="2.0" step="0.01" value="1.0">
    </div>
    <div class="group">
        <label>Time Speed</label>
        <input type="range" id="speed" min="0.5" max="2.0" step="0.01" value="1.0">
    </div>
    <div class="group">
        <label>Reverb Size</label>
        <input type="range" id="reverb" min="0" max="1" step="0.05" value="0">
    </div>
    <div class="group">
        <label>Auto-Tune (Main Key Sync)</label>
        <input type="checkbox" id="autotune">
    </div>
    <button class="btn" id="wacky">WACKY MODE!</button>
</div>

<div id="main-stage"><canvas id="canvas"></canvas></div>
<div id="bottom-panel">
    <button id="play-btn">▶</button>
    <canvas id="trace"></canvas>
</div>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const traceCanvas = document.getElementById('trace');
    const tCtx = traceCanvas.getContext('2d');
    
    let audioCtx, source, analyser, gainNode, reverbNode, pitchNode;
    let audioBuffer = null;
    let isPlaying = false;
    let startTime = 0;
    let lastLissajousUpdate = 0;
    let lissA = 3, lissB = 2;

    // Default Settings
    const color = "rgb(244, 235, 226)";
    
    async function initAudio(file) {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const arrayBuffer = await file.arrayBuffer();
        audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        setupNodes();
    }

    function setupNodes() {
        if (source) source.stop();
        source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.loop = true;

        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 2048;

        gainNode = audioCtx.createGain();
        
        // REVERB SETUP
        reverbNode = audioCtx.createConvolver();
        const length = audioCtx.sampleRate * 2.5;
        const impulse = audioCtx.createBuffer(2, length, audioCtx.sampleRate);
        for (let i = 0; i < length; i++) {
            const decay = Math.pow(1 - i / length, 2);
            impulse.getChannelData(0)[i] = (Math.random() * 2 - 1) * decay;
            impulse.getChannelData(1)[i] = (Math.random() * 2 - 1) * decay;
        }
        reverbNode.buffer = impulse;

        const reverbGain = audioCtx.createGain();
        reverbGain.gain.value = document.getElementById('reverb').value;

        // PITCH
        source.playbackRate.value = document.getElementById('pitch').value;

        // Routing
        source.connect(analyser);
        source.connect(reverbNode);
        reverbNode.connect(reverbGain);
        reverbGain.connect(gainNode);
        analyser.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        
        source.start(0);
        isPlaying = true;
        animate();
    }

    document.getElementById('upload').onchange = (e) => initAudio(e.target.files[0]);
    document.getElementById('play-btn').onclick = () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        isPlaying ? audioCtx.suspend() : audioCtx.resume();
        isPlaying = !isPlaying;
        document.getElementById('play-btn').innerText = isPlaying ? "⏸" : "▶";
    };

    // Live Sliders
    document.getElementById('vol').oninput = (e) => gainNode.gain.value = e.target.value;
    document.getElementById('pitch').oninput = (e) => {
        if(source) source.playbackRate.value = e.target.value;
    };
    document.getElementById('wacky').onclick = () => {
        document.getElementById('pitch').value = Math.random() * 2;
        if(source) source.playbackRate.value = document.getElementById('pitch').value;
        lissA = Math.random() * 10;
        lissB = Math.random() * 10;
    };

    function animate() {
        requestAnimationFrame(animate);
        canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight;
        traceCanvas.width = traceCanvas.clientWidth; traceCanvas.height = 120;
        
        const data = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(data);
        const timeData = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(timeData);

        // Shift Lissajous settings every 5s
        if (Date.now() - lastLissajousUpdate > 5000) {
            lissA = Math.floor(Math.random() * 5) + 1;
            lissB = Math.floor(Math.random() * 5) + 1;
            lastLissajousUpdate = Date.now();
        }

        ctx.strokeStyle = color;
        ctx.lineWidth = document.getElementById('weight').value;
        ctx.shadowBlur = 15 * document.getElementById('glow').value;
        ctx.shadowColor = color;
        
        const mode = document.getElementById('mode').value;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        if (mode === 'lissajous') {
            ctx.beginPath();
            for (let i = 0; i < timeData.length; i++) {
                const angle = (i / timeData.length) * Math.PI * 2;
                const v = timeData[i] / 128.0;
                const x = centerX + Math.sin(angle * lissA) * (canvas.width / 4) * v;
                const y = centerY + Math.cos(angle * lissB) * (canvas.height / 4) * v;
                if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
        } 
        else if (mode === 'circular') {
            const radius = 100;
            const dist = parseInt(document.getElementById('dist').value);
            for (let i = 0; i < data.length; i += (1 + dist)) {
                const angle = (i / data.length) * Math.PI * 2;
                const len = data[i] * 0.8;
                ctx.beginPath();
                ctx.moveTo(centerX + Math.cos(angle) * radius, centerY + Math.sin(angle) * radius);
                ctx.lineTo(centerX + Math.cos(angle) * (radius + len), centerY + Math.sin(angle) * (radius + len));
                ctx.stroke();
            }
        }

        // DRAW BOTTOM TRACE
        const progress = (audioCtx.currentTime % audioBuffer.duration) / audioBuffer.duration;
        const tx = progress * traceCanvas.width;
        tCtx.strokeStyle = color;
        tCtx.lineWidth = 2;
        tCtx.beginPath();
        tCtx.moveTo(tx, 60 - data[10]/4);
        tCtx.lineTo(tx, 60 + data[10]/4);
        tCtx.stroke();
    }
</script>
</body>
</html>
